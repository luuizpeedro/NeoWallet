<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>NeoWallet — Controle de Finanças</title>
    <meta
      name="description"
      content="Controle de finanças pessoais (somente UI). Sem marcas reais. HTML, CSS e JS puro."
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
      rel="stylesheet"
    />
    <style>
      /* ============================
      NeoWallet — CSS (mobile-first)
      ============================ */
      :root {
        --bg: #f4f7f9;
        --surface: #ffffff;
        --surface-2: #e8ecf1;
        --text: #1a202c;
        --muted: #718096;
        --primary: #5a67d8;
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #5a67d8 100%);
        --primary-contrast: #ffffff;
        --accent: #3182ce;
        --danger: #e53e3e;
        --warning: #dd6b20;
        --success: #38a169;
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.05);
        --radius: 12px;
      }
      body[data-theme="dark"] {
        --bg: #0d1117;
        --surface: #161b22;
        --surface-2: #21262d;
        --text: #c9d1d9;
        --muted: #8b949e;
        --primary: #58a6ff;
        --primary-gradient: linear-gradient(135deg, #58a6ff 0%, #308ce0 100%);
        --primary-contrast: #ffffff;
        --accent: #38a169;
        --danger: #e53e3e;
        --warning: #dd6b20;
        --success: #48bb78;
        --shadow: 0 6px 16px rgba(0, 0, 0, 0.4), 0 2px 8px rgba(0, 0, 0, 0.25);
      }

      /* Scrollbar moderna */
      ::-webkit-scrollbar {
        width: 8px;
        background-color: var(--surface-2);
        border-radius: 10px;
      }
      ::-webkit-scrollbar-thumb {
        background-color: var(--muted);
        border-radius: 10px;
      }
      body[data-theme="dark"] ::-webkit-scrollbar-track {
        background-color: var(--surface-2);
      }
      body[data-theme="dark"] ::-webkit-scrollbar-thumb {
        background-color: var(--muted);
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI,
          Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji",
          "Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
        transition: background-color 0.3s, color 0.3s;
      }
      a {
        color: inherit;
        text-decoration: none;
      }
      button {
        font: inherit;
        cursor: pointer;
        transition: all 0.15s ease-in-out;
      }
      .container {
        padding: 16px;
        padding-bottom: 80px;
        transition: opacity 0.3s;
      }
      .container.fade-out {
        opacity: 0;
      }

      /* App Shell */
      .appbar {
        position: sticky;
        top: 0;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 14px 16px;
        background: var(--surface);
        box-shadow: var(--shadow);
      }
      .appbar-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.5rem;
        font-weight: 800; /* Mais ousado */
        letter-spacing: 0.3px;
      }
      .appbar-title img {
        height: 50px;
        width: auto;
      }
      .appbar-actions {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .chip {
        background: var(--surface-2);
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 0.9rem;
      }
      .bottomnav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 10;
        display: flex;
        justify-content: space-around;
        gap: 4px;
        background: var(--surface);
        box-shadow: var(--shadow);
        padding: 8px;
        border-top-left-radius: 14px;
        border-top-right-radius: 14px;
      }
      .bottomnav a {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 8px 6px;
        border-radius: 12px;
        font-size: 0.7rem;
        color: var(--muted);
        flex: 1;
        transition: background-color 0.2s, color 0.2s;
      }
      .bottomnav a:hover {
        background: var(--surface-2);
        color: var(--text);
      }
      .bottomnav a .icon {
        font-size: 1.2rem;
        margin-bottom: 4px;
        font-variation-settings: "FILL" 0, "wght" 400;
      }
      .bottomnav a.active {
        background: var(--surface-2);
        color: var(--text);
      }
      .bottomnav a.active .icon {
        font-variation-settings: "FILL" 1, "wght" 700;
      }

      /* Card */
      .card {
        background: var(--surface);
        padding: 16px;
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        transition: box-shadow 0.3s ease;
      }
      .card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(0, 0, 0, 0.08);
      }
      .row {
        display: flex;
        gap: 12px;
      }
      .row.wrap {
        flex-wrap: wrap;
      }
      .row.center {
        align-items: center;
      }
      .col {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* Botões */
      .btn {
        background: var(--primary-gradient); /* Gradiente */
        color: var(--primary-contrast);
        border: none;
        padding: 10px 14px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .btn:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      }
      .btn:active {
        transform: translateY(1px) scale(0.99);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .btn.ghost {
        background: var(--surface-2);
        color: var(--text);
        box-shadow: none;
      }
      .btn.ghost:hover {
        background: var(--muted);
        color: var(--surface);
      }
      .btn.tonal {
        background: var(--surface-2);
        color: var(--primary);
        box-shadow: none;
      }
      .btn.tonal:hover {
        background: var(--muted);
        color: var(--surface);
      }
      .btn.icon {
        padding: 8px;
        border-radius: 10px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--primary);
        background: var(--surface-2);
        box-shadow: none;
      }
      .btn.icon svg {
        width: 20px;
        height: 20px;
      }
      body[data-theme="dark"] .btn.icon {
        color: var(--primary);
      }

      .balance {
        font-size: 2rem;
        font-weight: 800;
        letter-spacing: 0.5px;
      }
      .balance.masked {
        font-size: 1.5rem;
        letter-spacing: 2px;
      }

      .actions {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }
      @media (min-width: 768px) {
        .actions {
          grid-template-columns: repeat(4, 1fr);
        }
      }

      .list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        border-radius: 12px;
        background: var(--surface);
        border: 1px solid var(--surface-2);
        transition: background-color 0.2s, box-shadow 0.2s;
      }
      .item:hover {
        background: var(--surface-2);
      }
      .item .left {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .item .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: var(--accent);
      }
      .item .title {
        font-weight: 700;
      }
      .item .subtitle {
        font-size: 0.8rem;
        color: var(--muted);
      }
      .amount.plus {
        color: var(--success);
      }
      .amount.minus {
        color: var(--danger);
      }

      .section-title {
        font-size: 1rem;
        font-weight: 800;
        margin: 2px 0 8px;
      }

      /* Inputs */
      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .field label {
        font-size: 0.85rem;
        color: var(--muted);
      }
      .input,
      select,
      textarea {
        width: 100%;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid var(--surface-2);
        outline: none;
        background: var(--surface-2);
        color: var(--text);
        transition: border-color 0.2s;
      }
      .input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
      }
      body[data-theme="dark"] .input,
      body[data-theme="dark"] select,
      body[data-theme="dark"] textarea {
        border-color: #4a5568;
        background: #2d3748;
      }

      /* Modals */
      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 50;
        transition: opacity 0.3s;
      }
      .modal {
        width: min(520px, 92vw);
        background: var(--surface);
        border-radius: 18px;
        padding: 16px;
        box-shadow: var(--shadow);
        border: 1px solid var(--surface-2);
      }
      .modal-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 8px;
      }

      /* Toast */
      .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 80px;
        background: var(--surface);
        padding: 10px 14px;
        border-radius: 12px;
        display: none;
        box-shadow: var(--shadow);
        transition: all 0.3s ease;
      }
      .toast.success {
        background-color: var(--success);
        color: var(--primary-contrast);
      }
      .toast.danger {
        background-color: var(--danger);
        color: var(--primary-contrast);
      }
      .toast.warning {
        background-color: var(--warning);
        color: var(--primary-contrast);
      }

      /* Skeleton */
      .skeleton {
        background: linear-gradient(
          90deg,
          var(--surface-2) 25%,
          var(--muted) 50%,
          var(--surface-2) 75%
        );
        background-size: 200% 100%;
        animation: shimmer 1.2s infinite;
        border-radius: 12px;
        height: 16px;
      }
      body[data-theme="dark"] .skeleton {
        background: linear-gradient(
          90deg,
          #4a5568 25%,
          #718096 50%,
          #4a5568 75%
        );
      }
      @keyframes shimmer {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Responsive */
      @media (min-width: 768px) {
        .grid-2 {
          display: grid;
          grid-template-columns: 1.1fr 1fr;
          gap: 12px;
        }
      }

      footer.note {
        text-align: center;
        font-size: 0.8rem;
        color: var(--muted);
        padding: 16px;
      }
      .badge {
        display: inline-block;
        font-size: 0.7rem;
        padding: 4px 8px;
        border-radius: 10px;
        background: var(--surface-2);
        color: var(--muted);
      }

      /* Progess Bar */
      .progress-bar-container {
        width: 100%;
        background-color: var(--surface-2);
        border-radius: 999px;
        height: 8px;
        overflow: hidden;
      }
      .progress-bar {
        background-color: var(--primary);
        height: 100%;
        border-radius: 999px;
        transition: width 0.3s ease-in-out;
      }
      .progress-bar.success {
        background-color: var(--success);
      }
      .progress-bar.danger {
        background-color: var(--danger);
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 32px 16px;
        color: var(--muted);
      }
      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 12px;
      }
      .empty-state .material-symbols-outlined {
        font-size: 4rem;
        margin-bottom: 1rem;
      }

      /* Pie Chart */
      .pie-chart {
        width: 100%;
        height: 200px;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }
      .pie-chart svg {
        width: 180px;
        height: 180px;
        transform: rotate(-90deg);
      }
      .pie-chart-legend {
        list-style: none;
        padding: 0;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        font-size: 0.8rem;
      }
      .pie-chart-legend li {
        display: flex;
        align-items: center;
      }
      .pie-chart-legend li .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
      }
      /* Animação do Gráfico de Pizza */
      .pie-chart-slice {
        stroke-dasharray: 251.327; /* 80 * 2 * PI (raio 40) */
        stroke-dashoffset: 251.327;
        animation: slice-in 0.8s forwards;
      }
      @keyframes slice-in {
        to {
          stroke-dashoffset: 0;
        }
      }
      /* Mini Bar Chart */
      .mini-bar-chart {
        display: flex;
        justify-content: space-around;
        align-items: flex-end;
        height: 80px;
        width: 100%;
        gap: 4px;
        padding-top: 10px;
      }
      .mini-bar {
        flex: 1;
        background-color: var(--primary);
        border-radius: 4px 4px 0 0;
        transition: height 0.5s ease-out;
        min-width: 8px;
        opacity: 0.8;
      }
    </style>
  </head>
  <body>
    <header class="appbar" role="banner">
      <div class="appbar-title" aria-label="Aplicativo NeoWallet">
        <img src="assets/img/logo.png" alt="Logo do NeoWallet" />
        <span>NeoWallet</span>
      </div>
      <div class="appbar-actions">
        <button
          id="themeToggle"
          class="btn icon"
          aria-label="Alternar tema"
          title="Tema claro/escuro"
        >
          <span class="material-symbols-outlined">light_mode</span>
        </button>
        <span class="chip" aria-live="polite" id="greeting">Olá</span>
      </div>
    </header>

    <main id="view" class="container" role="main" aria-live="polite"></main>

    <nav class="bottomnav" role="navigation" aria-label="Navegação inferior">
      <a href="#/dashboard" id="nav-dashboard" aria-label="Início">
        <span class="icon material-symbols-outlined">home</span
        ><span>Início</span>
      </a>
      <a href="#/relatorios" id="nav-relatorios" aria-label="Relatórios">
        <span class="icon material-symbols-outlined">monitoring</span
        ><span>Relatórios</span>
      </a>
      <a href="#/extrato" id="nav-extrato" aria-label="Extrato">
        <span class="icon material-symbols-outlined">receipt_long</span
        ><span>Extrato</span>
      </a>
      <a href="#/categorias" id="nav-categorias" aria-label="Categorias">
        <span class="icon material-symbols-outlined">label</span
        ><span>Categorias</span>
      </a>
      <a href="#/metas" id="nav-metas" aria-label="Metas">
        <span class="icon material-symbols-outlined">savings</span
        ><span>Metas</span>
      </a>
      <a href="#/recorrentes" id="nav-recorrentes" aria-label="Recorrentes">
        <span class="icon material-symbols-outlined">cached</span
        ><span>Recorrentes</span>
      </a>
      <a href="#/contas" id="nav-contas" aria-label="Contas">
        <span class="icon material-symbols-outlined"
          >account_balance_wallet</span
        ><span>Contas</span>
      </a>
      <a href="#/perfil" id="nav-perfil" aria-label="Perfil">
        <span class="icon material-symbols-outlined">settings</span
        ><span>Perfil</span>
      </a>
    </nav>

    <footer class="note">
      Protótipo educacional, sem valor real. Não insira dados pessoais.
    </footer>

    <div
      class="modal-backdrop"
      id="modalBackdrop"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    ></div>
    <div class="toast" id="toast" role="status" aria-live="polite"></div>

    <script>
      // ============================
      // NeoWallet — JS puro
      // Código Completo e Atualizado
      // ============================
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      const StorageKey = "neowallet.v5";
      const State = {
        data: null,
        load() {
          try {
            const raw = localStorage.getItem(StorageKey);
            if (raw) {
              this.data = JSON.parse(raw);
            }
          } catch {}
          if (!this.data) this.data = this.seed();
        },
        save() {
          localStorage.setItem(StorageKey, JSON.stringify(this.data));
        },
        reset() {
          localStorage.removeItem(StorageKey);
          this.data = this.seed();
        },
        seed() {
          const mainAccountId = uid();
          return {
            theme: "light",
            balanceVisible: true,
            profile: { name: "Alex", email: "alex@example.com", lang: "pt-BR" },
            accounts: [
              { id: mainAccountId, name: "Conta Principal", balance: 1250.55 },
              { id: uid(), name: "Poupança", balance: 5000.0 },
            ],
            categories: [
              { name: "Moradia", budget: 800 },
              { name: "Alimentação", budget: 400 },
              { name: "Transporte", budget: 150 },
              { name: "Lazer", budget: 200 },
              { name: "Saúde", budget: 100 },
              { name: "Ajustes", budget: 0 },
              { name: "Outros", budget: 0 },
            ],
            tx: [
              {
                id: uid(),
                date: daysAgo(1),
                type: "crédito",
                category: "Salário",
                desc: "Pagamento",
                amount: 2500.0,
                accountId: mainAccountId,
              },
              {
                id: uid(),
                date: daysAgo(0),
                type: "débito",
                category: "Alimentação",
                desc: "Compras no mercado",
                amount: -152.4,
                accountId: mainAccountId,
              },
              {
                id: uid(),
                date: daysAgo(0),
                type: "débito",
                category: "Transporte",
                desc: "App de corrida",
                amount: -28.9,
                accountId: mainAccountId,
              },
            ],
            recurringTx: [
              {
                id: uid(),
                name: "Aluguel",
                amount: 800,
                category: "Moradia",
                type: "débito",
                accountId: mainAccountId,
                frequency: "monthly",
                lastAddedDate: daysAgo(30),
              },
              {
                id: uid(),
                name: "Assinatura de streaming",
                amount: 29.9,
                category: "Lazer",
                type: "débito",
                accountId: mainAccountId,
                frequency: "monthly",
                lastAddedDate: daysAgo(15),
              },
            ],
            goals: [
              {
                id: uid(),
                name: "Reserva de Emergência",
                target: 10000,
                saved: 5000,
                deadline: "2026-12-31",
              },
              {
                id: uid(),
                name: "Viagem para a praia",
                target: 2500,
                saved: 500,
                deadline: "2026-06-30",
              },
            ],
          };
        },
      };

      function uid() {
        return Math.random().toString(36).slice(2, 10);
      }
      function daysAgo(n) {
        const d = new Date();
        d.setDate(d.getDate() - n);
        return d.toISOString();
      }
      function formatBRL(v) {
        return v.toLocaleString("pt-BR", {
          style: "currency",
          currency: "BRL",
        });
      }

      function toast(msg, type = "info") {
        const t = $("#toast");
        t.textContent = msg;
        t.className = `toast ${type}`;
        t.style.display = "block";
        clearTimeout(t._h);
        t._h = setTimeout(() => (t.style.display = "none"), 2200);
      }

      function setTheme(theme) {
        document.body.dataset.theme = theme;
        const icon = $("#themeToggle .material-symbols-outlined");
        icon.textContent = theme === "dark" ? "light_mode" : "dark_mode";
      }

      function setActiveNav() {
        $$(".bottomnav a").forEach((a) => a.classList.remove("active"));
        const hash = location.hash.replace("#/", "") || "dashboard";
        const el = document.getElementById("nav-" + hash);
        if (el) el.classList.add("active");
      }

      function checkRecurringTx() {
        const now = new Date();
        let changed = false;
        State.data.recurringTx.forEach((rtx) => {
          const last = new Date(rtx.lastAddedDate);
          let shouldAdd = false;

          if (rtx.frequency === "monthly") {
            if (
              now.getMonth() !== last.getMonth() ||
              now.getFullYear() !== last.getFullYear()
            ) {
              shouldAdd = true;
            }
          } else if (rtx.frequency === "weekly") {
            const daysDiff = Math.floor(
              (now.getTime() - last.getTime()) / (1000 * 60 * 60 * 24)
            );
            if (daysDiff >= 7) {
              shouldAdd = true;
            }
          }

          if (shouldAdd) {
            const account = State.data.accounts.find(
              (acc) => acc.id === rtx.accountId
            );
            if (account) {
              account.balance +=
                rtx.type === "crédito"
                  ? Math.abs(rtx.amount)
                  : -Math.abs(rtx.amount);
            }
            State.data.tx.push({
              id: uid(),
              date: now.toISOString(),
              type: rtx.type,
              category: rtx.category,
              desc: rtx.name,
              amount: rtx.amount,
              accountId: rtx.accountId,
            });
            rtx.lastAddedDate = now.toISOString();
            changed = true;
          }
        });

        if (changed) {
          State.save();
          toast("Transações recorrentes adicionadas!", "info");
        }
      }

      // Router
      const Routes = {
        dashboard: renderDashboard,
        relatorios: renderRelatorios,
        extrato: renderTransactions,
        categorias: renderCategories, // Categoria restaurada
        metas: renderMetas,
        contas: renderAccounts,
        recorrentes: renderRecurringTx,
        perfil: renderProfile,
      };

      function navigate() {
        setActiveNav();
        checkRecurringTx();
        const hash = (location.hash || "#/dashboard").replace("#/", "");
        const view = $("#view");

        view.classList.add("fade-out");
        setTimeout(() => {
          const fn = Routes[hash] || Routes.dashboard;
          view.innerHTML = "";
          fn(view);
          view.classList.remove("fade-out");
        }, 300);
      }

      // ---------- Modals ----------
      function openModal(title, contentHTML, actionsHTML) {
        const b = $("#modalBackdrop");
        b.innerHTML = `
        <div class="modal" role="document">
          <div class="modal-header">
            <strong>${title}</strong>
            <button class="btn ghost" aria-label="Fechar" onclick="closeModal()">✕</button>
          </div>
          <div class="col">${contentHTML}</div>
          <div class="row" style="margin-top:12px; justify-content:flex-end; gap:8px">${
            actionsHTML || ""
          }</div>
        </div>`;
        b.style.display = "flex";
        b.setAttribute("aria-hidden", "false");
        b.addEventListener("click", (e) => {
          if (e.target === b) closeModal();
        });
        const first = b.querySelector("input,select,textarea,button");
        if (first) first.focus();
      }
      function closeModal() {
        const b = $("#modalBackdrop");
        b.style.display = "none";
        b.setAttribute("aria-hidden", "true");
        b.innerHTML = "";
        navigate();
      }

      function uiConfirmModal(title, message, onConfirm) {
        openModal(
          title,
          `<p class="subtitle" style="text-align: center;">${message}</p>`,
          `
              <button class="btn ghost" onclick="closeModal()">Cancelar</button>
              <button class="btn danger" id="confirmBtn">Confirmar</button>
              `
        );
        $("#confirmBtn").onclick = () => {
          onConfirm();
          closeModal();
        };
      }

      // ---------- CSV ----------
      function exportCSV() {
        const now = new Date().toLocaleString("pt-BR", {
          dateStyle: "short",
          timeStyle: "short",
        });
        const header = [
          `NeoWallet - Extrato Financeiro`,
          `Data de Exportação: ${now}`,
          ``,
        ];
        const rows = [
          ["ID", "Data", "Tipo", "Categoria", "Descrição", "Valor", "Conta"],
        ];
        State.data.tx.forEach((t) => {
          const txDate = new Date(t.date).toLocaleString("pt-BR", {
            dateStyle: "short",
            timeStyle: "short",
          });
          const accountName =
            State.data.accounts.find((acc) => acc.id === t.accountId)?.name ||
            "N/A";
          rows.push([
            t.id,
            txDate,
            t.type,
            t.category,
            t.desc,
            t.amount.toFixed(2),
            accountName,
          ]);
        });

        const csvContent =
          header.join("\n") +
          "\n" +
          rows
            .map((r) =>
              r.map((c) => `"${c.toString().replace(/"/g, '""')}"`).join(";")
            )
            .join("\n");

        const blob = new Blob([csvContent], {
          type: "text/csv;charset=utf-8;",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "extrato_neowallet.csv";
        a.click();
        URL.revokeObjectURL(a.href);
        toast("CSV exportado", "success");
      }

      function getTotalBalance() {
        return State.data.accounts.reduce(
          (sum, account) => sum + account.balance,
          0
        );
      }

      // ---------- Screens ----------
      function renderDashboard(root) {
        const d = State.data;
        $("#greeting").textContent = `Olá, ${d.profile.name}`;

        const totalBalance = getTotalBalance();
        const balanceValue = d.balanceVisible
          ? formatBRL(totalBalance)
          : "••••••";

        const accountOptions = d.accounts
          .map((acc) => `<option value="${acc.id}">${acc.name}</option>`)
          .join("");

        const alertsHTML = checkAlerts();

        // Mini-gráfico de gastos
        const dailyExpenses = getDailyExpenses(7);
        const maxExpense = Math.max(
          ...dailyExpenses.map((item) => item.amount)
        );
        const miniBarChartHTML = dailyExpenses
          .map((item) => {
            const height =
              maxExpense > 0 ? (item.amount / maxExpense) * 100 : 0;
            return `<div class="mini-bar" style="height:${height}%" title="${
              item.date
            }: ${formatBRL(item.amount)}"></div>`;
          })
          .join("");

        const listHTML = d.tx
          .slice()
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .slice(0, 8)
          .map(txItem)
          .join("");

        root.innerHTML = `
        <div class="grid-2" style="gap:12px;">
            <div class="col" style="gap:12px">
                ${
                  alertsHTML
                    ? `<section class="card"><div class="section-title" style="color: var(--danger);">Alertas</div><div class="list">${alertsHTML}</div></section>`
                    : ""
                }
                <section class="card" aria-label="Resumo do Saldo">
                  <div class="col">
                    <div>
                      <div class="badge">Saldo Total</div>
                      <div class="balance ${
                        !d.balanceVisible ? "masked" : ""
                      }" id="balanceValue">${balanceValue}</div>
                    </div>
                    <div class="row center" style="gap:8px; margin-top: 16px; justify-content: flex-end;">
                      <button class="btn icon" aria-label="Mostrar/Ocultar saldo" onclick="toggleBalanceVisibility()">
                        ${
                          d.balanceVisible
                            ? '<span class="material-symbols-outlined">visibility_off</span>'
                            : '<span class="material-symbols-outlined">visibility</span>'
                        }
                      </button>
                    </div>
                  </div>
                </section>

                <section class="card" aria-label="Ações rápidas">
                    <div class="section-title">Ações Rápidas</div>
                    <div class="row wrap" style="justify-content: center; gap: 1rem;">
                        <button class="btn tonal" onclick="uiAddTx('débito')">
                          <span class="material-symbols-outlined">arrow_downward</span>
                          Despesa
                        </button>
                        <button class="btn tonal" onclick="uiAddTx('crédito')">
                          <span class="material-symbols-outlined">arrow_upward</span>
                          Receita
                        </button>
                    </div>
                </section>
            </div>
            
            <div class="col" style="gap:12px">
                <section class="card" aria-label="Gastos dos últimos 7 dias">
                    <div class="section-title">Gastos Diários (7 dias)</div>
                    <div class="mini-bar-chart">
                      ${
                        miniBarChartHTML ||
                        emptyState("Nenhum gasto recente", "bar_chart")
                      }
                    </div>
                </section>
                <section class="card" aria-label="Extrato recente">
                    <div class="row center" style="justify-content:space-between; margin-bottom:8px">
                        <div class="section-title">Movimentações recentes</div>
                    </div>
                    <div id="txList" class="list">${
                      listHTML ||
                      emptyState(
                        "Nenhuma movimentação para exibir.",
                        "list_alt"
                      )
                    }</div>
                </section>
            </div>
        </div>
        `;
      }

      // Nova função para buscar gastos diários
      function getDailyExpenses(days) {
        const expenses = [];
        const now = new Date();
        now.setHours(0, 0, 0, 0);

        for (let i = days - 1; i >= 0; i--) {
          const date = new Date(now);
          date.setDate(now.getDate() - i);

          const total = State.data.tx
            .filter(
              (t) =>
                t.type === "débito" &&
                new Date(t.date).toDateString() === date.toDateString()
            )
            .reduce((sum, t) => sum + Math.abs(t.amount), 0);

          expenses.push({
            date: date.toLocaleDateString("pt-BR"),
            amount: total,
          });
        }
        return expenses;
      }

      function checkAlerts() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        let alerts = [];

        // Checar orçamentos
        const monthlyExpenses = State.data.tx
          .filter((t) => t.amount < 0 && new Date(t.date) >= startOfMonth)
          .reduce((acc, t) => {
            acc[t.category] = (acc[t.category] || 0) + Math.abs(t.amount);
            return acc;
          }, {});

        State.data.categories.forEach((cat) => {
          if (cat.budget > 0) {
            const spent = monthlyExpenses[cat.name] || 0;
            const progress = spent / cat.budget;
            if (progress >= 1) {
              alerts.push(`O orçamento de **${cat.name}** foi atingido!`);
            } else if (progress >= 0.8) {
              alerts.push(
                `Atenção: o orçamento de **${cat.name}** está quase no limite.`
              );
            }
          }
        });

        // Checar metas
        State.data.goals.forEach((goal) => {
          const deadline = new Date(goal.deadline);
          const remainingDays = (deadline - now) / (1000 * 60 * 60 * 24);
          if (
            remainingDays > 0 &&
            remainingDays <= 30 &&
            goal.saved < goal.target
          ) {
            alerts.push(
              `Faltam ${Math.round(
                remainingDays
              )} dias para o prazo da meta **${goal.name}**.`
            );
          }
        });

        if (alerts.length === 0) return "";

        return alerts
          .map(
            (msg) =>
              `<div class="item"><div class="left"><span class="material-symbols-outlined" style="color: var(--danger);">warning</span><div class="subtitle">${msg}</div></div></div>`
          )
          .join("");
      }

      function renderRelatorios(root) {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisMonthTx = State.data.tx.filter(
          (t) => new Date(t.date) >= startOfMonth
        );

        const monthYear = now.toLocaleDateString("pt-BR", {
          month: "long",
          year: "numeric",
        });

        const totalReceita = thisMonthTx
          .filter((t) => t.type === "crédito")
          .reduce((sum, t) => sum + t.amount, 0);
        const totalDespesa = thisMonthTx
          .filter((t) => t.type === "débito")
          .reduce((sum, t) => sum + t.amount, 0);

        root.innerHTML = `
            <div class="card" style="margin-bottom:12px;">
                <div class="section-title">Resumo do Mês</div>
                <div class="row wrap center">
                    <div class="col" style="flex:1;">
                        <span class="subtitle" style="color: var(--success);">Receita Total</span>
                        <div style="font-size:1.2rem; font-weight:700;">${formatBRL(
                          totalReceita
                        )}</div>
                    </div>
                    <div class="col" style="flex:1;">
                        <span class="subtitle" style="color: var(--danger);">Despesa Total</span>
                        <div style="font-size:1.2rem; font-weight:700;">${formatBRL(
                          totalDespesa
                        )}</div>
                    </div>
                </div>
            </div>
            
            <div class="grid-2">
                <section class="card" aria-label="Gastos do mês">
                    <div class="section-title">Gastos por Categoria (${monthYear})</div>
                    ${
                      monthlyExpenseSummary() ||
                      emptyState(
                        "Não há gastos registrados este mês.",
                        "pie_chart"
                      )
                    }
                </section>
                <section class="card" aria-label="Evolução do Saldo">
                    <div class="section-title">Evolução do Saldo (${monthYear})</div>
                    <div id="chart" style="min-height: 200px">${renderBalanceChart()}</div>
                </section>
            </div>
            <section class="card" style="margin-top:12px;">
                <div class="section-title">Gráfico de Pizza</div>
                ${
                  renderPieChart() ||
                  emptyState(
                    "Não há despesas para exibir no gráfico.",
                    "pie_chart"
                  )
                }
            </section>
        `;
      }

      function renderBalanceChart() {
        const balanceHistory = getBalanceHistory();
        if (balanceHistory.length < 2) {
          return emptyState(
            "Adicione mais movimentações para ver o gráfico.",
            "analytics"
          );
        }

        const dates = balanceHistory.map((d) => d.date);
        const balances = balanceHistory.map((d) => d.balance);

        const svgWidth = 250;
        const svgHeight = 200;
        const margin = { top: 10, right: 10, bottom: 20, left: 50 };
        const chartWidth = svgWidth - margin.left - margin.right;
        const chartHeight = svgHeight - margin.top - margin.bottom;

        const minBalance = Math.min(...balances);
        const maxBalance = Math.max(...balances);
        const yScale = (balance) =>
          chartHeight -
          ((balance - minBalance) / (maxBalance - minBalance)) * chartHeight +
          margin.top;

        let pathData = "";
        if (balances.length > 0) {
          pathData = balances
            .map((balance, i) => {
              const x = (i / (balances.length - 1)) * chartWidth + margin.left;
              const y = yScale(balance);
              return `${i === 0 ? "M" : "L"} ${x},${y}`;
            })
            .join(" ");
        }

        return `
            <svg width="100%" height="${svgHeight}" viewBox="0 0 ${svgWidth} ${svgHeight}">
              <path d="${pathData}" fill="none" stroke="var(--primary)" stroke-width="2" />
              <g class="y-axis">
                <text x="0" y="${
                  yScale(minBalance) + 5
                }" font-size="10" fill="var(--muted)">${formatBRL(
          minBalance
        )}</text>
                <text x="0" y="${
                  yScale(maxBalance) + 5
                }" font-size="10" fill="var(--muted)">${formatBRL(
          maxBalance
        )}</text>
              </g>
            </svg>
          `;
      }

      function getBalanceHistory() {
        const sortedTx = State.data.tx.sort(
          (a, b) => new Date(a.date) - new Date(b.date)
        );
        if (sortedTx.length === 0) return [];

        const history = [];
        let currentBalance = State.data.accounts.reduce((sum, acc) => {
          const pastTx = sortedTx.filter((t) => new Date(t.date) > new Date());
          return sum + acc.balance - pastTx.reduce((s, t) => s + t.amount, 0);
        }, 0);

        history.push({
          date: new Date().toISOString(),
          balance: currentBalance,
        });

        const now = new Date();
        for (let i = sortedTx.length - 1; i >= 0; i--) {
          if (new Date(sortedTx[i].date) < now) {
            currentBalance -= sortedTx[i].amount;
            history.unshift({
              date: sortedTx[i].date,
              balance: currentBalance,
            });
          }
        }

        return history;
      }

      function renderPieChart() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisMonthExpenses = State.data.tx.filter(
          (t) => new Date(t.date) >= startOfMonth && t.amount < 0
        );

        if (thisMonthExpenses.length === 0) return "";

        const expensesByCategory = thisMonthExpenses.reduce((acc, tx) => {
          const cat = tx.category;
          acc[cat] = (acc[cat] || 0) + Math.abs(tx.amount);
          return acc;
        }, {});

        const totalExpenses = Object.values(expensesByCategory).reduce(
          (sum, val) => sum + val,
          0
        );
        if (totalExpenses === 0) return "";

        const colors = [
          "#4299e1",
          "#ed8936",
          "#48bb78",
          "#9f7aea",
          "#e53e3e",
          "#ecc94b",
          "#667eea",
        ];
        let startAngle = 0;
        let legendHTML = "";
        let slicesHTML = "";
        let colorIndex = 0;

        for (const category in expensesByCategory) {
          const value = expensesByCategory[category];
          const percentage = value / totalExpenses;
          const endAngle = startAngle + percentage * 360;
          const largeArcFlag = percentage > 0.5 ? 1 : 0;
          const color = colors[colorIndex % colors.length];

          const x1 = 50 + 40 * Math.cos((Math.PI * startAngle) / 180);
          const y1 = 50 + 40 * Math.sin((Math.PI * startAngle) / 180);
          const x2 = 50 + 40 * Math.cos((Math.PI * endAngle) / 180);
          const y2 = 50 + 40 * Math.sin((Math.PI * endAngle) / 180);
          const radius = 40;

          slicesHTML += `
            <path
              class="pie-chart-slice"
              d="M 50,50 L ${x1},${y1} A ${radius},${radius} 0 ${largeArcFlag},1 ${x2},${y2} Z"
              fill="${color}"
              style="animation-delay: ${colorIndex * 0.15}s"
            />
          `;
          legendHTML += `<li><span class="dot" style="background:${color}"></span>${category} (${(
            percentage * 100
          ).toFixed(1)}%)</li>`;

          startAngle = endAngle;
          colorIndex++;
        }

        return `
            <div class="row wrap center" style="justify-content:space-between">
                <div class="pie-chart">
                    <svg viewBox="0 0 100 100">${slicesHTML}</svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <div style="font-size: 0.8rem; color: var(--muted);">Total</div>
                        <div style="font-size: 1.2rem; font-weight: bold;">${formatBRL(
                          totalExpenses
                        )}</div>
                    </div>
                </div>
                <ul class="pie-chart-legend" style="flex:1">
                    ${legendHTML}
                </ul>
            </div>
          `;
      }

      function txItem(t) {
        const sign = t.amount >= 0 ? "plus" : "minus";
        const date = new Date(t.date).toLocaleDateString("pt-BR");
        const account =
          State.data.accounts.find((acc) => acc.id === t.accountId)?.name ||
          "N/A";
        return `<div class="item" role="listitem">
        <div class="left">
          <div class="dot"></div>
          <div>
            <div class="title">${t.category}</div>
            <div class="subtitle">${t.desc} • ${date} • ${account}</div>
          </div>
        </div>
        <div class="amount ${sign}">${t.amount >= 0 ? "+" : ""}${formatBRL(
          t.amount
        )}</div>
        <div class="row" style="gap:4px">
            <button class="btn ghost" onclick="uiEditTx('${
              t.id
            }')" title="Editar Transação">
                <span class="material-symbols-outlined" style="font-size:1.2rem;">edit</span>
            </button>
            <button class="btn ghost" onclick="uiDeleteTx('${
              t.id
            }')" title="Excluir Transação">
                <span class="material-symbols-outlined" style="font-size:1.2rem;">delete</span>
            </button>
        </div>
      </div>`;
      }

      function monthlyExpenseSummary() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const thisMonthTx = State.data.tx.filter(
          (t) => new Date(t.date) >= startOfMonth
        );

        if (thisMonthTx.length === 0) {
          return emptyState(
            "Não há gastos registrados neste mês.",
            "pie_chart"
          );
        }

        const totalsByCategory = thisMonthTx.reduce((acc, tx) => {
          if (tx.amount < 0) {
            acc[tx.category] = (acc[tx.category] || 0) + Math.abs(tx.amount);
          }
          return acc;
        }, {});

        const categoriesHTML = State.data.categories
          .map((cat) => {
            const spent = totalsByCategory[cat.name] || 0;
            const budget = cat.budget;
            let progress = 0;
            let progressBarClass = "";
            let remaining = "";

            if (budget > 0) {
              progress = Math.min((spent / budget) * 100, 100);
              const remainingValue = budget - spent;
              if (progress >= 100) {
                progressBarClass = "danger";
                remaining = `Orçamento estourado em ${formatBRL(
                  Math.abs(remainingValue)
                )}`;
              } else if (progress > 80) {
                progressBarClass = "warning";
                remaining = `${formatBRL(remainingValue)} restantes`;
              } else {
                progressBarClass = "success";
                remaining = `${formatBRL(remainingValue)} restantes`;
              }
            } else {
              remaining = "";
              progressBarClass = "success";
            }

            return `
                <div>
                    <div class="row center" style="justify-content:space-between">
                        <div class="subtitle">${cat.name}</div>
                        <div class="subtitle">${formatBRL(spent)} / ${formatBRL(
              budget
            )}</div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar ${progressBarClass}" style="width: ${progress}%"></div>
                    </div>
                    ${
                      remaining
                        ? `<div class="subtitle" style="margin-top: 4px; text-align: right; color: var(--muted); font-size: 0.75rem;">${remaining}</div>`
                        : ""
                    }
                </div>
            `;
          })
          .join("");

        return `
            <div class="col" style="gap:8px">
                ${categoriesHTML}
            </div>
        `;
      }

      function renderTransactions(root) {
        const d = State.data;
        const listHTML = d.tx
          .slice()
          .sort((a, b) => new Date(b.date) - new Date(a.date))
          .map(txItem)
          .join("");

        root.innerHTML = `
        <section class="card" style="margin-top:12px" aria-label="Extrato completo">
          <div class="row center" style="justify-content:space-between;">
            <div class="section-title">Extrato Completo</div>
            <div class="row center" style="gap:8px">
              <button class="btn tonal" onclick="exportCSV()" aria-label="Exportar CSV">Exportar CSV</button>
            </div>
          </div>
          <div id="txList" class="list" style="margin-top:8px">${
            listHTML ||
            emptyState("Nenhuma movimentação para exibir.", "list_alt")
          }</div>
        </section>
        `;
      }

      function renderAccounts(root) {
        const d = State.data;
        const accountListHTML = d.accounts
          .map(
            (acc) => `
            <div class="item">
                <div class="left">
                    <div class="dot" style="background: var(--primary);"></div>
                    <div>
                        <div class="title">${acc.name}</div>
                        <div class="subtitle">${formatBRL(acc.balance)}</div>
                    </div>
                </div>
                <div class="row" style="gap:4px">
                  <button class="btn ghost" onclick="uiTransfer('${
                    acc.id
                  }')" title="Transferir">
                      <span class="material-symbols-outlined" style="font-size:1.2rem;">swap_horiz</span>
                  </button>
                  <button class="btn ghost" onclick="uiAdjustBalance('${
                    acc.id
                  }')" title="Ajustar Saldo">
                    <span class="material-symbols-outlined" style="font-size:1.2rem;">edit_square</span>
                  </button>
                  <button class="btn ghost" onclick="uiEditAccount('${
                    acc.id
                  }')" title="Editar Nome da Conta">
                    <span class="material-symbols-outlined" style="font-size:1.2rem;">edit</span>
                  </button>
                </div>
            </div>
        `
          )
          .join("");

        root.innerHTML = `
            <section class="card">
                <div class="row center" style="justify-content:space-between;">
                    <div class="section-title">Suas Contas</div>
                    <button class="btn" onclick="uiAddAccount()">Adicionar Conta</button>
                </div>
                <div class="list" style="margin-top:8px">${
                  accountListHTML ||
                  emptyState(
                    "Nenhuma conta cadastrada.",
                    "account_balance_wallet"
                  )
                }</div>
            </section>
        `;
      }

      function renderMetas(root) {
        const goalsHTML = State.data.goals
          .map((goal) => {
            const progress = Math.min((goal.saved / goal.target) * 100, 100);
            const remaining = goal.target - goal.saved;
            const remainingText =
              remaining > 0
                ? `${formatBRL(remaining)} restantes`
                : "Concluída!";
            const deadline = new Date(goal.deadline).toLocaleDateString(
              "pt-BR"
            );

            return `
                <div class="item">
                    <div class="left">
                        <div class="dot"></div>
                        <div>
                            <div class="title">${goal.name}</div>
                            <div class="subtitle">
                                ${formatBRL(goal.saved)} de ${formatBRL(
              goal.target
            )} • Prazo: ${deadline}
                            </div>
                            <div class="progress-bar-container" style="margin-top: 4px; width: 150px;">
                                <div class="progress-bar ${
                                  progress === 100 ? "success" : ""
                                }" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row" style="gap:4px">
                        <button class="btn ghost" onclick="uiContributeGoal('${
                          goal.id
                        }')" title="Contribuir para a meta">
                            <span class="material-symbols-outlined" style="font-size:1.2rem;">add</span>
                        </button>
                    </div>
                </div>
            `;
          })
          .join("");

        root.innerHTML = `
            <section class="card">
                <div class="row center" style="justify-content:space-between;">
                    <div class="section-title">Metas de Economia</div>
                    <button class="btn" onclick="uiAddGoal()">Nova Meta</button>
                </div>
                <div class="list" style="margin-top:8px;">
                    ${
                      goalsHTML ||
                      emptyState(
                        "Nenhuma meta de economia cadastrada.",
                        "savings"
                      )
                    }
                </div>
            </section>
        `;
      }

      function renderRecurringTx(root) {
        const listHTML = State.data.recurringTx
          .map(
            (rtx) => `
              <div class="item">
                  <div class="left">
                      <div class="dot" style="background: var(--primary);"></div>
                      <div>
                          <div class="title">${rtx.name}</div>
                          <div class="subtitle">${rtx.category} • ${
              rtx.frequency === "monthly" ? "Mensal" : "Semanal"
            } • Conta: ${
              State.data.accounts.find((acc) => acc.id === rtx.accountId)
                ?.name || "N/A"
            }</div>
                      </div>
                  </div>
                  <div class="amount ${
                    rtx.type === "crédito" ? "plus" : "minus"
                  }">${rtx.type === "crédito" ? "+" : ""}${formatBRL(
              rtx.amount
            )}</div>
              </div>
          `
          )
          .join("");

        root.innerHTML = `
              <section class="card">
                  <div class="row center" style="justify-content:space-between;">
                      <div class="section-title">Transações Recorrentes</div>
                      <button class="btn" onclick="uiAddRecurringTx()">Nova Recorrência</button>
                  </div>
                  <div class="list" style="margin-top:8px;">
                      ${
                        listHTML ||
                        emptyState(
                          "Nenhuma transação recorrente cadastrada.",
                          "cached"
                        )
                      }
                  </div>
              </section>
          `;
      }

      function renderCategories(root) {
        const d = State.data;
        const categoryListHTML = d.categories
          .map(
            (cat) => `
              <div class="item">
                  <div class="left">
                      <div class="dot" style="background: var(--primary);"></div>
                      <div>
                          <div class="title">${cat.name}</div>
                          <div class="subtitle">Orçamento: ${formatBRL(
                            cat.budget
                          )}</div>
                      </div>
                  </div>
                  <button class="btn ghost" onclick="uiEditCategory('${
                    cat.name
                  }')">Editar</button>
              </div>
          `
          )
          .join("");

        root.innerHTML = `
              <section class="card">
                  <div class="row center" style="justify-content:space-between;">
                      <div class="section-title">Categorias e Orçamentos</div>
                      <button class="btn" onclick="uiAddCategory()">Adicionar categoria</button>
                  </div>
                  <div class="list" style="margin-top:8px">${
                    categoryListHTML ||
                    emptyState("Nenhuma categoria cadastrada.", "label")
                  }</div>
              </section>
          `;
      }

      function renderProfile(root) {
        const d = State.data;
        root.innerHTML = `
        <section class="card">
          <div class="section-title">Perfil</div>
          <div class="row wrap">
            <div class="field"><label>Nome</label><input id="name" class="input" value="${d.profile.name}" /></div>
            <div class="field"><label>E-mail</label><input id="email" class="input" value="${d.profile.email}" /></div>
          </div>
          <div class="row" style="margin-top:10px; gap:8px">
            <button class="btn" onclick="uiSaveProfile()">Salvar</button>
            <button class="btn ghost" onclick="State.reset(); State.save(); navigate(); toast('App resetado');">Resetar app</button>
          </div>
        </section>

        <section class="card" style="margin-top:12px">
          <div class="section-title">Preferências</div>
          <div class="row" style="gap:8px">
            <button class="btn" onclick="toggleTheme()">Alternar tema</button>
          </div>
          <details style="margin-top:10px">
            <summary>FAQ</summary>
            <p class="subtitle">Este é um protótipo educacional. Não insira dados reais.</p>
          </details>
        </section>
        `;
      }

      // ---------- UI Actions ----------
      function uiAddAccount() {
        openModal(
          "Nova Conta",
          `
            <div class="field"><label>Nome da Conta</label><input id="accName" class="input" placeholder="Ex.: Conta Corrente" /></div>
            <div class="field"><label>Saldo Inicial</label><input id="accBalance" class="input" type="number" step="0.01" value="0" /></div>
          `,
          `
            <button class="btn ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn" onclick="(function(){
                const name = $('#accName').value.trim();
                const balance = parseFloat($('#accBalance').value) || 0;
                if (!name) { toast('Nome inválido', 'danger'); return; }
                if (State.data.accounts.find(c => c.name === name)) { toast('Conta já existe', 'warning'); return; }
                State.data.accounts.push({ id: uid(), name, balance });
                State.save();
                closeModal();
                toast('Conta adicionada', 'success');
            })()">Salvar</button>
          `
        );
      }

      // Transferência entre contas
      function uiTransfer() {
        const accountOptions = State.data.accounts
          .map((acc) => `<option value="${acc.id}">${acc.name}</option>`)
          .join("");
        openModal(
          "Transferir Saldo",
          `
          <div class="field"><label>De</label><select id="fromAcc" class="input">${accountOptions}</select></div>
          <div class="field"><label>Para</label><select id="toAcc" class="input">${accountOptions}</select></div>
          <div class="field"><label>Valor</label><input id="transferAmount" class="input" type="number" step="0.01" /></div>
          `,
          `
          <button class="btn ghost" onclick="closeModal()">Cancelar</button>
          <button class="btn" onclick="(function(){
            const fromId = $('#fromAcc').value;
            const toId = $('#toAcc').value;
            const amount = parseFloat($('#transferAmount').value);

            if (fromId === toId) { toast('Origem e destino não podem ser a mesma conta.', 'danger'); return; }
            if (isNaN(amount) || amount <= 0) { toast('Informe um valor válido para a transferência.', 'danger'); return; }

            const fromAcc = State.data.accounts.find(acc => acc.id === fromId);
            const toAcc = State.data.accounts.find(acc => acc.id === toId);

            if (fromAcc.balance < amount) { toast('Saldo insuficiente na conta de origem.', 'danger'); return; }
            
            fromAcc.balance -= amount;
            toAcc.balance += amount;

            State.data.tx.push({ id: uid(), date: new Date().toISOString(), type: 'débito', category: 'Transferência', desc: 'Transferência para ' + toAcc.name, amount: -amount, accountId: fromId });
            State.data.tx.push({ id: uid(), date: new Date().toISOString(), type: 'crédito', category: 'Transferência', desc: 'Transferência de ' + fromAcc.name, amount: amount, accountId: toId });
            State.save();
            closeModal();
            toast('Transferência realizada!', 'success');
          })()">Transferir</button>
          `
        );
      }

      function uiAdjustBalance(accountId) {
        const account = State.data.accounts.find((acc) => acc.id === accountId);
        if (!account) return;

        openModal(
          `Ajustar Saldo de ${account.name}`,
          `
              <p class="subtitle" style="text-align: center;">O saldo atual é: <strong>${formatBRL(
                account.balance
              )}</strong></p>
              <div class="field"><label>Valor do Ajuste</label><input id="adjustmentValue" class="input" type="number" step="0.01" placeholder="Ex: 50.00" /></div>
              <p class="subtitle">Use um valor positivo para aumentar o saldo e negativo para diminuir.</p>
              `,
          `
              <button class="btn ghost" onclick="closeModal()">Cancelar</button>
              <button class="btn" onclick="(function(){
                  const value = parseFloat($('#adjustmentValue').value);
                  if (isNaN(value) || value === 0) {
                      toast('Por favor, informe um valor válido.', 'danger');
                      return;
                  }

                  const newTx = {
                      id: uid(),
                      date: new Date().toISOString(),
                      type: value > 0 ? 'crédito' : 'débito',
                      category: 'Ajustes',
                      desc: 'Ajuste de Saldo',
                      amount: value,
                      accountId: accountId
                  };
                  
                  State.data.tx.push(newTx);
                  account.balance += value;
                  State.save();
                  
                  closeModal();
                  toast('Saldo ajustado com sucesso.', 'success');
              })()">Aplicar Ajuste</button>
              `
        );
      }

      function uiEditAccount(accountId) {
        const account = State.data.accounts.find((acc) => acc.id === accountId);
        if (!account) return;

        openModal(
          `Editar ${account.name}`,
          `
            <div class="field"><label>Nome da Conta</label><input id="accName" class="input" value="${account.name}" /></div>
            <p class="subtitle" style="text-align: center;">Para ajustar o saldo, crie uma transação de "Ajuste".</p>
          `,
          `
            <button class="btn ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn danger" onclick="(function(){
                if(State.data.accounts.length <= 1) {
                    toast('Não é possível excluir a única conta.', 'danger');
                    return;
                }
                uiConfirmModal(
                    'Confirmar Exclusão',
                    'Tem certeza que deseja excluir esta conta? As transações relacionadas não serão removidas.',
                    () => {
                        State.data.accounts = State.data.accounts.filter(acc => acc.id !== '${accountId}');
                        State.save();
                        navigate();
                        toast('Conta excluída', 'success');
                    }
                );
            })()">Excluir</button>
            <button class="btn" onclick="(function(){
                const newName = $('#accName').value.trim();
                if (!newName) { toast('Nome inválido', 'danger'); return; }
                
                account.name = newName;
                State.save();
                closeModal();
                toast('Conta atualizada', 'success');
            })()">Salvar</button>
          `
        );
      }

      function uiAddTx(type = "débito") {
        const categoryOptions = State.data.categories
          .map((cat) => `<option value="${cat.name}">${cat.name}</option>`)
          .join("");
        const accountOptions = State.data.accounts
          .map((acc) => `<option value="${acc.id}">${acc.name}</option>`)
          .join("");
        openModal(
          "Adicionar movimentação",
          `
          <div class="row wrap">
            <div class="field" style="flex:1; min-width:140px">
              <label>Tipo</label>
              <select id="txType" class="input">
                <option value="crédito" ${
                  type === "crédito" ? "selected" : ""
                }>Receita</option>
                <option value="débito" ${
                  type === "débito" ? "selected" : ""
                }>Despesa</option>
              </select>
            </div>
            <div class="field" style="flex:1; min-width:160px">
              <label>Categoria</label>
              <select id="txCat" class="input">${categoryOptions}</select>
            </div>
          </div>
          <div class="field"><label>Descrição</label><input id="txDesc" class="input" placeholder="Ex.: Compras" /></div>
          <div class="row wrap">
            <div class="field" style="flex:1; min-width:140px">
              <label>Valor</label>
              <input id="txVal" class="input" type="number" step="0.01" />
            </div>
            <div class="field" style="flex:1; min-width:180px">
              <label>Conta</label>
              <select id="txAccount" class="input">${accountOptions}</select>
            </div>
          </div>
          <div class="field"><label>Data</label><input id="txDate" class="input" type="date" value="${new Date()
            .toISOString()
            .slice(0, 10)}" /></div>
        `,
          `
          <button class="btn ghost" onclick="closeModal()">Cancelar</button>
          <button class="btn" onclick="(function(){
            const type=$('#txType').value; const cat=$('#txCat').value||'Outros'; const desc=$('#txDesc').value||''; const v=parseFloat($('#txVal').value||'0'); const dt=$('#txDate').value||new Date().toISOString().slice(0,10); const accountId = $('#txAccount').value;
            if(isNaN(v)||v===0){ toast('Informe um valor válido', 'danger'); return; }
            const amount = type==='crédito'? Math.abs(v) : -Math.abs(v);
            
            const account = State.data.accounts.find(acc => acc.id === accountId);
            if (account) {
              account.balance += amount;
            }

            State.data.tx.push({ id: uid(), date: new Date(dt).toISOString(), type, category: cat, desc, amount, accountId });
            State.save(); 
            closeModal(); 
            toast('Movimentação adicionada', 'success');
          })()">Adicionar</button>
          `
        );
      }

      // Função para editar transação existente
      function uiEditTx(txId) {
        const tx = State.data.tx.find((t) => t.id === txId);
        if (!tx) return;

        const categoryOptions = State.data.categories
          .map(
            (cat) =>
              `<option value="${cat.name}" ${
                tx.category === cat.name ? "selected" : ""
              }>${cat.name}</option>`
          )
          .join("");
        const accountOptions = State.data.accounts
          .map(
            (acc) =>
              `<option value="${acc.id}" ${
                tx.accountId === acc.id ? "selected" : ""
              }>${acc.name}</option>`
          )
          .join("");

        const originalAmount = Math.abs(tx.amount);
        const originalType = tx.amount > 0 ? "crédito" : "débito";

        openModal(
          `Editar Transação`,
          `
          <div class="row wrap">
            <div class="field" style="flex:1; min-width:140px">
              <label>Tipo</label>
              <select id="txTypeEdit" class="input">
                <option value="crédito" ${
                  originalType === "crédito" ? "selected" : ""
                }>Receita</option>
                <option value="débito" ${
                  originalType === "débito" ? "selected" : ""
                }>Despesa</option>
              </select>
            </div>
            <div class="field" style="flex:1; min-width:160px">
              <label>Categoria</label>
              <select id="txCatEdit" class="input">${categoryOptions}</select>
            </div>
          </div>
          <div class="field"><label>Descrição</label><input id="txDescEdit" class="input" value="${
            tx.desc
          }" /></div>
          <div class="row wrap">
            <div class="field" style="flex:1; min-width:140px">
              <label>Valor</label>
              <input id="txValEdit" class="input" type="number" step="0.01" value="${originalAmount}" />
            </div>
            <div class="field" style="flex:1; min-width:180px">
              <label>Conta</label>
              <select id="txAccountEdit" class="input">${accountOptions}</select>
            </div>
          </div>
          <div class="field"><label>Data</label><input id="txDateEdit" class="input" type="date" value="${tx.date.slice(
            0,
            10
          )}" /></div>
          `,
          `
          <button class="btn ghost" onclick="closeModal()">Cancelar</button>
          <button class="btn" onclick="(function(){
            const newType = $('#txTypeEdit').value;
            const newCat = $('#txCatEdit').value;
            const newDesc = $('#txDescEdit').value;
            const newVal = parseFloat($('#txValEdit').value);
            const newDate = $('#txDateEdit').value;
            const newAccountId = $('#txAccountEdit').value;

            if (isNaN(newVal) || newVal <= 0) { toast('Informe um valor válido', 'danger'); return; }

            const oldAcc = State.data.accounts.find(a => a.id === tx.accountId);
            if (oldAcc) { oldAcc.balance -= tx.amount; }
            
            tx.type = newType;
            tx.category = newCat;
            tx.desc = newDesc;
            tx.amount = newType === 'crédito' ? newVal : -newVal;
            tx.date = new Date(newDate).toISOString();
            tx.accountId = newAccountId;

            const newAcc = State.data.accounts.find(a => a.id === tx.accountId);
            if (newAcc) { newAcc.balance += tx.amount; }

            State.save();
            closeModal();
            toast('Transação atualizada', 'success');
          })()">Salvar</button>
          `
        );
      }

      // Função para excluir transação
      function uiDeleteTx(txId) {
        const tx = State.data.tx.find((t) => t.id === txId);
        if (!tx) return;

        uiConfirmModal(
          "Confirmar Exclusão",
          "Tem certeza que deseja excluir a transação de **" +
            formatBRL(tx.amount) +
            "**?",
          () => {
            const account = State.data.accounts.find(
              (acc) => acc.id === tx.accountId
            );
            if (account) {
              account.balance -= tx.amount;
            }
            State.data.tx = State.data.tx.filter((t) => t.id !== txId);
            State.save();
            navigate();
            toast("Transação excluída", "success");
          }
        );
      }

      function uiAddCategory() {
        openModal(
          "Nova Categoria",
          `
            <div class="field"><label>Nome da Categoria</label><input id="catName" class="input" placeholder="Ex.: Lazer" /></div>
            <div class="field"><label>Orçamento Mensal (opcional)</label><input id="catBudget" class="input" type="number" step="0.01" placeholder="0.00" /></div>
          `,
          `
            <button class="btn ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn" onclick="(function(){
                const name = $('#catName').value.trim();
                const budget = parseFloat($('#catBudget').value) || 0;
                if (!name) { toast('Nome inválido', 'danger'); return; }
                if (State.data.categories.find(c => c.name === name)) { toast('Categoria já existe', 'warning'); return; }
                State.data.categories.push({ name, budget });
                State.save();
                closeModal();
                toast('Categoria adicionada', 'success');
            })()">Salvar</button>
          `
        );
      }

      function uiEditCategory(catName) {
        const category = State.data.categories.find((c) => c.name === catName);
        openModal(
          `Editar ${catName}`,
          `
            <div class="field"><label>Novo Nome</label><input id="catName" class="input" value="${category.name}" /></div>
            <div class="field"><label>Novo Orçamento Mensal</label><input id="catBudget" class="input" type="number" step="0.01" value="${category.budget}" /></div>
          `,
          `
            <button class="btn ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn danger" onclick="(function(){
              if (catName === 'Ajustes') {
                toast('A categoria "Ajustes" não pode ser excluída.', 'danger');
                return;
              }
              uiConfirmModal(
                'Confirmar Exclusão',
                'Tem certeza que deseja excluir esta categoria? As transações existentes não serão alteradas.',
                () => {
                  State.data.categories = State.data.categories.filter(c => c.name !== '${catName}');
                  State.save();
                  navigate();
                  toast('Categoria excluída', 'success');
                }
              );
            })()">Excluir</button>
            <button class="btn" onclick="(function(){
                const name = $('#catName').value.trim();
                const budget = parseFloat($('#catBudget').value) || 0;
                if (!name) { toast('Nome inválido', 'danger'); return; }
                category.name = name;
                category.budget = budget;
                State.save();
                closeModal();
                toast('Categoria atualizada', 'success');
            })()">Salvar</button>
          `
        );
      }

      // Contribuir para meta
      function uiContributeGoal(goalId) {
        const goal = State.data.goals.find((g) => g.id === goalId);
        if (!goal) return;

        const accountOptions = State.data.accounts
          .map((acc) => `<option value="${acc.id}">${acc.name}</option>`)
          .join("");

        openModal(
          `Contribuir para ${goal.name}`,
          `
          <p class="subtitle" style="text-align: center;">Progresso atual: ${formatBRL(
            goal.saved
          )} de ${formatBRL(goal.target)}</p>
          <div class="field"><label>Valor da Contribuição</label><input id="contributionAmount" class="input" type="number" step="0.01" /></div>
          <div class="field"><label>Conta de Origem</label><select id="contributeFromAcc" class="input">${accountOptions}</select></div>
          `,
          `
          <button class="btn ghost" onclick="closeModal()">Cancelar</button>
          <button class="btn" onclick="(function(){
            const amount = parseFloat($('#contributionAmount').value);
            const fromAccId = $('#contributeFromAcc').value;

            if (isNaN(amount) || amount <= 0) { toast('Informe um valor válido.', 'danger'); return; }

            const fromAcc = State.data.accounts.find(a => a.id === fromAccId);
            if (fromAcc.balance < amount) { toast('Saldo insuficiente na conta de origem.', 'danger'); return; }

            fromAcc.balance -= amount;
            goal.saved += amount;

            State.data.tx.push({ id: uid(), date: new Date().toISOString(), type: 'débito', category: 'Metas', desc: 'Contribuição para ' + goal.name, amount: -amount, accountId: fromAccId });
            State.save();
            closeModal();
            toast('Contribuição para meta realizada!', 'success');
          })()">Contribuir</button>
          `
        );
      }

      function uiAddGoal() {
        openModal(
          "Nova Meta",
          `
            <div class="field"><label>Nome da Meta</label><input id="goalName" class="input" placeholder="Ex.: Entrada para o carro" /></div>
            <div class="field"><label>Valor Total</label><input id="goalTarget" class="input" type="number" step="0.01" placeholder="0.00" /></div>
            <div class="field"><label>Valor Já Salvo</label><input id="goalSaved" class="input" type="number" step="0.01" value="0" /></div>
            <div class="field"><label>Prazo</label><input id="goalDeadline" class="input" type="date" /></div>
          `,
          `
            <button class="btn ghost" onclick="closeModal()">Cancelar</button>
            <button class="btn" onclick="(function(){
                const name = $('#goalName').value.trim();
                const target = parseFloat($('#goalTarget').value) || 0;
                const saved = parseFloat($('#goalSaved').value) || 0;
                const deadline = $('#goalDeadline').value;
                if (!name || target <= 0 || !deadline) { toast('Preencha todos os campos corretamente', 'danger'); return; }
                State.data.goals.push({ id: uid(), name, target, saved, deadline });
                State.save();
                closeModal();
                toast('Meta adicionada', 'success');
            })()">Salvar</button>
          `
        );
      }

      function uiAddRecurringTx() {
        const categoryOptions = State.data.categories
          .map((cat) => `<option value="${cat.name}">${cat.name}</option>`)
          .join("");
        const accountOptions = State.data.accounts
          .map((acc) => `<option value="${acc.id}">${acc.name}</option>`)
          .join("");
        openModal(
          "Nova Transação Recorrente",
          `
          <div class="field"><label>Nome</label><input id="rtxName" class="input" placeholder="Ex.: Aluguel" /></div>
          <div class="row wrap">
            <div class="field" style="flex:1; min-width:140px">
              <label>Tipo</label>
              <select id="rtxType" class="input"><option value="crédito">Receita</option><option value="débito">Despesa</option></select>
            </div>
            <div class="field" style="flex:1; min-width:160px">
              <label>Categoria</label>
              <select id="rtxCat" class="input">${categoryOptions}</select>
            </div>
          </div>
          <div class="row wrap">
            <div class="field" style="flex:1; min-width:140px">
              <label>Valor</label>
              <input id="rtxVal" class="input" type="number" step="0.01" />
            </div>
            <div class="field" style="flex:1; min-width:180px">
              <label>Conta</label>
              <select id="rtxAccount" class="input">${accountOptions}</select>
            </div>
          </div>
          <div class="field">
              <label>Frequência</label>
              <select id="rtxFreq" class="input">
                  <option value="monthly">Mensal</option>
                  <option value="weekly">Semanal</option>
              </select>
          </div>
        `,
          `
          <button class="btn ghost" onclick="closeModal()">Cancelar</button>
          <button class="btn" onclick="(function(){
            const name=$('#rtxName').value.trim(); const type=$('#rtxType').value; const cat=$('#rtxCat').value||'Outros'; const v=parseFloat($('#rtxVal').value||'0'); const accountId = $('#rtxAccount').value; const freq = $('#rtxFreq').value;
            if(!name||isNaN(v)||v===0){ toast('Preencha os campos corretamente', 'danger'); return; }
            
            State.data.recurringTx.push({ id: uid(), name, type, amount: v, category: cat, accountId, frequency: freq, lastAddedDate: new Date().toISOString() });
            State.save(); 
            closeModal(); 
            toast('Recorrência adicionada', 'success');
          })()">Adicionar</button>
          `
        );
      }

      function uiSaveProfile() {
        const n = $("#name").value || "Usuário";
        const e = $("#email").value || "user@example.com";
        State.data.profile.name = n;
        State.data.profile.email = e;
        State.save();
        toast("Perfil salvo", "success");
        $("#greeting").textContent = `Olá, ${n}`;
      }

      function toggleTheme() {
        const t = State.data.theme === "light" ? "dark" : "light";
        State.data.theme = t;
        State.save();
        setTheme(t);
      }

      function toggleBalanceVisibility() {
        State.data.balanceVisible = !State.data.balanceVisible;
        State.save();
        navigate();
      }

      function emptyState(message, icon) {
        return `
            <div class="empty-state">
                <span class="material-symbols-outlined" style="font-size: 4rem;">${icon}</span>
                <p class="subtitle">${message}</p>
            </div>
        `;
      }

      // ---------- Helpers ----------
      function copyText(txt) {
        navigator.clipboard.writeText(txt);
        toast("Copiado para a área de transferência", "info");
      }

      function genRandomKey() {
        const s = Array.from(crypto.getRandomValues(new Uint8Array(12)))
          .map((v) => ("0" + (v % 36).toString(36)).slice(-1))
          .join("");
        return s.slice(0, 4) + "-" + s.slice(4, 8) + "-" + s.slice(8, 12);
      }

      function fakeQR(text) {
        let h = 0;
        for (let i = 0; i < text.length; i++) {
          h = (h * 31 + text.charCodeAt(i)) >>> 0;
        }
        const size = 21;
        const cell = 8;
        const pad = 8;
        let rects = "";
        for (let y = 0; y < size; y++) {
          for (let x = 0; x < size; x++) {
            const inFinder =
              (x < 7 && y < 7) ||
              (x > size - 8 && y < 7) ||
              (x < 7 && y > size - 8);
            let on = inFinder
              ? x === 0 ||
                x === 6 ||
                y === 0 ||
                y === 6 ||
                (x > 1 && x < 5 && y > 1 && y < 5)
              : (h >> (x * y + y) % 31) & 1;
            if (on) {
              rects += `<rect x="${pad + x * cell}" y="${
                pad + y * cell
              }" width="${cell}" height="${cell}" rx="1" ry="1"></rect>`;
            }
          }
        }
        const dim = pad * 2 + size * cell;
        return `<svg width="${dim}" height="${dim}" viewBox="0 0 ${dim} ${dim}" role="img" aria-label="QR ilustrativo"><rect width="100%" height="100%" fill="#fff" rx="12"/><g fill="#000">${rects}</g></svg>`;
      }

      // ---------- Init ----------
      State.load();
      setTheme(State.data.theme || "light");
      $("#themeToggle").addEventListener("click", toggleTheme);

      if (!location.hash) location.hash = "#/dashboard";
      window.addEventListener("hashchange", navigate);
      navigate();
    </script>
  </body>
</html>
